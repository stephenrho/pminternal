<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Handling missing data • pminternal</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Handling missing data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">pminternal</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/pminternal.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/missing-data.html">Handling missing data</a></li>
    <li><a class="dropdown-item" href="../articles/validate-examples.html">More examples</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stephenrho/pminternal/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Handling missing data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/stephenrho/pminternal/blob/main/vignettes/missing-data.Rmd" class="external-link"><code>vignettes/missing-data.Rmd</code></a></small>
      <div class="d-none name"><code>missing-data.Rmd</code></div>
    </div>

    
    
<p>Missing data can occur at various stages during the development and
assessment of clinical prediction models. Given the focus on prediction,
<code>validate</code> removes rows where the outcome is missing. But it
is possible to write user-defined model and prediction functions to
allow for missing predictors. The example code below shows how to
implement two approaches to dealing with missing predictor variables:
stacked multiple imputation and pattern submodels. Both approaches are
implemented with <code>glm</code> but could be easily modified to work
with other model fitting functions.</p>
<p>The code below simulates some data with 5 predictors, 3 of which have
missing values.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stephenrho/pminternal" class="external-link">pminternal</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/amices/mice" class="external-link">mice</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'mice'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     cbind, rbind</span></span>
<span></span>
<span><span class="co"># make some data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2345</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">800</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="va">p</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="va">p</span><span class="op">)</span></span>
<span><span class="va">LP</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="op">-</span><span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">LP</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.33125</span></span>
<span></span>
<span><span class="va">datcomp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add missingness</span></span>
<span><span class="va">datmis</span> <span class="op">&lt;-</span> <span class="va">datcomp</span></span>
<span><span class="va">datmis</span><span class="op">$</span><span class="va">X1</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">200</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">datmis</span><span class="op">$</span><span class="va">X2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">200</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">datmis</span><span class="op">$</span><span class="va">X3</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">200</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co"># assess performance before introducing missingness</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">datcomp</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">comp_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate.html">validate</a></span><span class="op">(</span><span class="va">mod</span>, method <span class="op">=</span> <span class="st">"cv_o"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           apparent optimism corrected  n</span></span>
<span><span class="co">#&gt; C         0.801121  -0.0013     0.802 10</span></span>
<span><span class="co">#&gt; Brier     0.164447   0.0000     0.164 10</span></span>
<span><span class="co">#&gt; Intercept 0.000000  -0.0320     0.032 10</span></span>
<span><span class="co">#&gt; Slope     1.000000  -0.0672     1.067 10</span></span>
<span><span class="co">#&gt; Eavg      0.000004  -0.0476     0.048 10</span></span>
<span><span class="co">#&gt; E50       0.000004  -0.0421     0.042 10</span></span>
<span><span class="co">#&gt; E90       0.000005  -0.0949     0.095 10</span></span>
<span><span class="co">#&gt; Emax      0.000009  -0.1058     0.106 10</span></span>
<span><span class="co">#&gt; ECI       0.000000  -0.4810     0.481 10</span></span></code></pre></div>
<div class="section level2">
<h2 id="stacked-multiple-imputation">Stacked multiple imputation<a class="anchor" aria-label="anchor" href="#stacked-multiple-imputation"></a>
</h2>
<p>This approach is discussed by <a href="https://doi.org/10.1373/clinchem.2008.115345" class="external-link">Janssen et
al. (2009)</a> and <a href="https://doi.org/10.1002/sim.8682" class="external-link">Hoogland
et al. (2020)</a> and involves the data used for ‘training’ the model to
be available at validation. Multiple imputation is used at development
and model coefficients are pooled across the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
imputed data sets. At validation or testing, the new data is stacked
onto the data used for development and multiple imputation algorithm is
run on the combined data set. The two articles above point out that it
is important that the new data at validation does not dominate the
imputation model and therefore advocate doing stacked imputation one row
of the validation set at a time. Here we use the <code>ignore</code>
argument to <code><a href="https://amices.org/mice/reference/mice.html" class="external-link">mice::mice</a></code> to omit the validation data from the
imputation model but still impute its missing observations. For each
individual in the validation/test dataset linear predictors are obtained
from each imputed dataset and then averaged before using the inverse
logit transform to convert to risk.</p>
<p>Note the functions below use the <code>mice</code> default arguments
(5 imputed datasets via predictive mean matching as all predictors are
continuous) but this could be easily tweaked. The functions also assume
that all variables should be used in the imputation model (including
<code>y</code>) but this could be changed via
<code>predictorMatrix</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_mi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">imp</span> <span class="op">&lt;-</span> <span class="fu">mice</span><span class="fu">::</span><span class="fu"><a href="https://amices.org/mice/reference/mice.html" class="external-link">mice</a></span><span class="op">(</span><span class="va">data</span>, printFlag <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># 5 imputed datasets via pmm</span></span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">imp</span>, <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span>, family<span class="op">=</span><span class="va">binomial</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">B</span> <span class="op">&lt;-</span> <span class="fu">mice</span><span class="fu">::</span><span class="fu"><a href="https://amices.org/mice/reference/pool.html" class="external-link">pool</a></span><span class="op">(</span><span class="va">fits</span><span class="op">)</span><span class="op">$</span><span class="va">pooled</span><span class="op">$</span><span class="va">estimate</span> <span class="co"># pooled coefs for predictions</span></span>
<span>  <span class="co"># save pooled coefficients and the data to do stacked imputation at validation</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">B</span>, <span class="va">data</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">pred_mi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">data</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># extract pooled coefs</span></span>
<span>  <span class="va">B</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="co"># stack the new data on the model fit data (model[[2]])</span></span>
<span>  <span class="va">dstacked</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://amices.org/mice/reference/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">model</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="va">i</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">model</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dstacked</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># impute stacked data</span></span>
<span>  <span class="co"># use ignore argument to ensure the test data doesn't influence</span></span>
<span>  <span class="co"># the imputation model but still gets imputed</span></span>
<span>  <span class="va">imp</span> <span class="op">&lt;-</span> <span class="fu">mice</span><span class="fu">::</span><span class="fu"><a href="https://amices.org/mice/reference/mice.html" class="external-link">mice</a></span><span class="op">(</span><span class="va">dstacked</span>, printFlag <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                    ignore <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dstacked</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="co"># get logit predicted risks for each imputed data set</span></span>
<span>  <span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">imp</span><span class="op">$</span><span class="va">m</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># complete(imp, x)[i, ] = get complete data set x and extract the </span></span>
<span>    <span class="co"># validation data i</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span>, data <span class="op">=</span> <span class="fu">mice</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/complete.html" class="external-link">complete</a></span><span class="op">(</span><span class="va">imp</span>, <span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span> </span>
<span>    <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">B</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="co"># average logit predictions, transform invlogit, and return</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">preds</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">mi_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate.html">validate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">datmis</span>, </span>
<span>                    model_fun <span class="op">=</span> <span class="va">model_mi</span>, pred_fun <span class="op">=</span> <span class="va">pred_mi</span>, </span>
<span>                    outcome <span class="op">=</span> <span class="st">"y"</span>, method <span class="op">=</span> <span class="st">"cv_o"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           apparent optimism corrected  n</span></span>
<span><span class="co">#&gt; C            0.821   0.0020     0.819 10</span></span>
<span><span class="co">#&gt; Brier        0.160  -0.0007     0.161 10</span></span>
<span><span class="co">#&gt; Intercept    0.221   0.0058     0.216 10</span></span>
<span><span class="co">#&gt; Slope        1.267  -0.0446     1.312 10</span></span>
<span><span class="co">#&gt; Eavg         0.038  -0.0330     0.071 10</span></span>
<span><span class="co">#&gt; E50          0.034  -0.0202     0.054 10</span></span>
<span><span class="co">#&gt; E90          0.079  -0.0591     0.138 10</span></span>
<span><span class="co">#&gt; Emax         0.084  -0.1489     0.232 10</span></span>
<span><span class="co">#&gt; ECI          0.200  -0.9423     1.142 10</span></span></code></pre></div>
<p>A drawback of this approach is that it requires the development data
to be available at validation/application. To avoid possible issues with
sharing the development data, it might be possible to simulate data to
have the same properties and missingness patterns to supply with the
prediction model at deployment (assuming the MI algorithms could also be
made available), although (to my knowledge) this approach hasn’t been
assessed.</p>
</div>
<div class="section level2">
<h2 id="pattern-submodels">Pattern submodels<a class="anchor" aria-label="anchor" href="#pattern-submodels"></a>
</h2>
<p>This approach involves fitting a separate prediction model for each
pattern of missing data <em>using only the data from that pattern</em>
<a href="https://doi.org/10.1093/biostatistics/kxy040" class="external-link">(Mercaldo &amp;
Blume, 2020)</a>. For example, if the pattern “00100” signifies that
variable 3 is missing and others are observed, a model omitting variable
3 is fit using rows where the missing pattern is “00100”. When testing
the model on new data the model corresponding to the missing data
pattern for each new observation is used.</p>
<p>As shown below we have 8 missing data patterns.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">md</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://amices.org/mice/reference/md.pattern.html" class="external-link">md.pattern</a></span><span class="op">(</span><span class="va">datmis</span><span class="op">)</span></span></code></pre></div>
<p><img src="missing-data_files/figure-html/unnamed-chunk-4-1.png" width="384"></p>
<p>The code below creates a new column in <code>datamis</code>
containing the observed missing data pattern, <code>mdp</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># store missing data pattern in data</span></span>
<span><span class="co"># as this will be useful</span></span>
<span><span class="va">datmis</span><span class="op">$</span><span class="va">mdp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">datmis</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span>, <span class="fl">1</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">datmis</span><span class="op">$</span><span class="va">mdp</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 00000 00100 01000 01100 10000 10100 11000 11100 </span></span>
<span><span class="co">#&gt;   344   107   108    41   113    36    35    16</span></span></code></pre></div>
<p>The list <code>submodels</code> contains the models that will be
estimated using data from each missing data pattern. As the number of
submodels could be very large (up to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>2</mn><mi>p</mi></msup><annotation encoding="application/x-tex">2^{p}</annotation></semantics></math>)
these could be created programmatically, though a large number of
submodels could be computationally prohibitive.</p>
<p>Following Mercaldo &amp; Blume, in <code>model_ps</code> the pattern
submodel is estimated if there are at least
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>p</mi></mrow><annotation encoding="application/x-tex">2p</annotation></semantics></math>
observations in a given pattern (in this case
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">p = 5</annotation></semantics></math>),
otherwise the submodel is estimated using all observations with complete
data for a given submodel (a ‘complete case submodel’). This is
important to note as while
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>&gt;</mo><mn>2</mn><mi>p</mi></mrow><annotation encoding="application/x-tex">n &gt; 2p</annotation></semantics></math>
for all patterns in the development data this is not guaranteed when
resampling for bootstrap or CV. It is possible to include patterns that
are not observed in the development data, although this will be of
little value to internal validation as we only use the observed
patterns.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">submodels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"00000"</span> <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span>,</span>
<span>  <span class="st">"00100"</span> <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span>,</span>
<span>  <span class="st">"01000"</span> <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span>,</span>
<span>  <span class="st">"01100"</span> <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span>,</span>
<span>  <span class="st">"10000"</span> <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span>,</span>
<span>  <span class="st">"10100"</span> <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span>,</span>
<span>  <span class="st">"11000"</span> <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span>,</span>
<span>  <span class="st">"11100"</span> <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_ps</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># this example uses submodels as an additional argument to </span></span>
<span>  <span class="co"># validate. But we could have put the submodels list in the </span></span>
<span>  <span class="co"># model_sub function</span></span>
<span>  <span class="va">dots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="st">"submodels"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dots</span><span class="op">)</span><span class="op">)</span> </span>
<span>    <span class="va">submodels</span> <span class="op">&lt;-</span> <span class="va">dots</span><span class="op">[[</span><span class="st">"submodels"</span><span class="op">]</span><span class="op">]</span> </span>
<span>  <span class="kw">else</span> </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"no submodels"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">patterns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">submodels</span><span class="op">)</span></span>
<span>  <span class="co"># all patterns in data should be in submodels, </span></span>
<span>  <span class="co"># but not necessarily vice versa (resampling </span></span>
<span>  <span class="co"># could have omitted a pattern)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">mdp</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">patterns</span><span class="op">)</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">patterns</span>, \<span class="op">(</span><span class="va">pat</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">f</span> <span class="op">&lt;-</span> <span class="va">submodels</span><span class="op">[[</span><span class="va">pat</span><span class="op">]</span><span class="op">]</span> <span class="co"># submodel formula</span></span>
<span>    <span class="co"># if n with pattern &gt; 2*p then fit submodel</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">mdp</span> <span class="op">==</span> <span class="va">pat</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">n</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">pat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">f</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">mdp</span> <span class="op">==</span> <span class="va">pat</span><span class="op">)</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>      <span class="co"># otherwise fit on complete cases</span></span>
<span>      <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">f</span>, data <span class="op">=</span> <span class="va">data</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span>      <span class="co"># note this approach allows submodels for patterns not </span></span>
<span>      <span class="co"># observed in development data. Though these will be </span></span>
<span>      <span class="co"># fit using complete cases (obviously not pattern specific data)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">fit</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fits</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">patterns</span></span>
<span>  <span class="va">fits</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">pred_ps</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">data</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">patterns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span>  <span class="co"># there needs to be a model for each pattern in data</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">mdp</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">patterns</span> <span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">patterns</span> <span class="op">&lt;-</span> <span class="va">patterns</span><span class="op">[</span><span class="va">patterns</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">mdp</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">patterns</span>, \<span class="op">(</span><span class="va">pat</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">mdp</span> <span class="op">==</span> <span class="va">pat</span><span class="op">)</span> <span class="co"># for reordering later</span></span>
<span>    <span class="va">pdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">mdp</span> <span class="op">==</span> <span class="va">pat</span><span class="op">)</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span><span class="op">[[</span><span class="va">pat</span><span class="op">]</span><span class="op">]</span>, newdata <span class="op">=</span> <span class="va">pdat</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">pdat</span><span class="op">$</span><span class="va">y</span>, p <span class="op">=</span> <span class="va">p</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">preds</span><span class="op">)</span></span>
<span>  <span class="co"># reorder so same as original data</span></span>
<span>  <span class="va">preds</span> <span class="op">&lt;-</span> <span class="va">preds</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">preds</span><span class="op">$</span><span class="va">i</span><span class="op">)</span>,<span class="op">]</span></span>
<span>  <span class="co"># all(data$y == preds$y)</span></span>
<span>  </span>
<span>  <span class="va">preds</span><span class="op">$</span><span class="va">p</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">sub_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate.html">validate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">datmis</span>, </span>
<span>                    model_fun <span class="op">=</span> <span class="va">model_ps</span>, pred_fun <span class="op">=</span> <span class="va">pred_ps</span>, </span>
<span>                    submodels <span class="op">=</span> <span class="va">submodels</span>, </span>
<span>                    outcome <span class="op">=</span> <span class="st">"y"</span>, method <span class="op">=</span> <span class="st">"cv_o"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           apparent optimism corrected  n</span></span>
<span><span class="co">#&gt; C         0.769339   0.0029     0.766 10</span></span>
<span><span class="co">#&gt; Brier     0.176129   0.0000     0.176 10</span></span>
<span><span class="co">#&gt; Intercept 0.000000  -0.0201     0.020 10</span></span>
<span><span class="co">#&gt; Slope     1.000000  -0.0521     1.052 10</span></span>
<span><span class="co">#&gt; Eavg      0.000001  -0.0458     0.046 10</span></span>
<span><span class="co">#&gt; E50       0.000001  -0.0403     0.040 10</span></span>
<span><span class="co">#&gt; E90       0.000001  -0.0856     0.086 10</span></span>
<span><span class="co">#&gt; Emax      0.000002  -0.1358     0.136 10</span></span>
<span><span class="co">#&gt; ECI       0.000000  -0.5370     0.537 10</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Stephen Rhodes.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
