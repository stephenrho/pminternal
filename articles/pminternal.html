<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Getting started with `pminternal` • pminternal</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting started with `pminternal`">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">pminternal</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/pminternal.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/missing-data.html">Handling missing data</a></li>
    <li><a class="dropdown-item" href="../articles/validate-examples.html">More examples</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stephenrho/pminternal/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Getting started with `pminternal`</h1>
                        <h4 data-toc-skip class="author">Stephen
Rhodes</h4>
            
            <h4 data-toc-skip class="date">2025-03-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stephenrho/pminternal/blob/v0.1.0/vignettes/pminternal.Rmd" class="external-link"><code>vignettes/pminternal.Rmd</code></a></small>
      <div class="d-none name"><code>pminternal.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In developing a clinical prediction model measures of model
performance are biased by the fact that we’re using the same data to fit
(‘train’) the model as evaluate it. Splitting data into development and
validation sets is inefficient. Bootstrapping or cross-validation can be
used to estimate bias-corrected measures of model performance. This is
known as ‘internal validation’ and addresses the question: what is the
expected performance of a model developed in the same way in a sample
selected from the same population? This is not to be confused with
‘external validation’ which assesses model performance in a different
population or setting.</p>
<p><code>pminternal</code> is inspired by the functions
<code>validate</code> and <code>predab.resample</code> from the
<code>rms</code> package. The aim is to provide a package that will work
with any user-defined model development procedure (assuming it can be
implemented in an R function). The package also implements more recently
proposed ‘stability plots’. Currently only binary outcomes are supported
but a goal is to eventually extend to other outcomes (survival,
ordinal).</p>
</div>
<div class="section level2">
<h2 id="supplying-a-model-via-fit">Supplying a model via <code>fit</code><a class="anchor" aria-label="anchor" href="#supplying-a-model-via-fit"></a>
</h2>
<p><code>validate</code> only needs a single argument to run,
<code>fit</code>. <code>fit</code> should be a fitted model that is
compatible with <code><a href="https://easystats.github.io/insight/reference/get_data.html" class="external-link">insight::get_data</a></code>,
<code><a href="https://easystats.github.io/insight/reference/find_response.html" class="external-link">insight::find_response</a></code>, <code><a href="https://easystats.github.io/insight/reference/get_call.html" class="external-link">insight::get_call</a></code>, and
<code><a href="https://marginaleffects.com/man/r/get_predict.html" class="external-link">marginaleffects::get_predict</a></code>. Models supported by insight
can be found by running <code><a href="https://easystats.github.io/insight/reference/is_model_supported.html" class="external-link">insight::supported_models()</a></code> (or run
<code>is_model_supported(fit)</code>); models supported by
<code>marginaleffects</code> are here <a href="https://marginaleffects.com/bonus/supported_models.html" class="external-link uri">https://marginaleffects.com/bonus/supported_models.html</a>.
As we’re dealing with binary outcomes, not all models listed will be
applicable.</p>
<p>The code below loads the GUSTO-I trial data, selects relevant
variables, subsets to reduce run time, fits a model (a
<code>glm</code>), and passes it to <code>validate</code> to produce
optimism corrected performance metrics via bootstrap resampling.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stephenrho/pminternal" class="external-link">pminternal</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hbiostat.org/R/Hmisc/" class="external-link">Hmisc</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'Hmisc'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     format.pval, units</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Hmisc/man/getHdata.html" class="external-link">getHdata</a></span><span class="op">(</span><span class="st">"gusto"</span><span class="op">)</span></span>
<span><span class="va">gusto</span> <span class="op">&lt;-</span> <span class="va">gusto</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sex"</span>, <span class="st">"age"</span>, <span class="st">"hyp"</span>, <span class="st">"htn"</span>, <span class="st">"hrt"</span>, <span class="st">"pmi"</span>, <span class="st">"ste"</span>, <span class="st">"day30"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">gusto</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">gusto</span><span class="op">$</span><span class="va">day30</span>; <span class="va">gusto</span><span class="op">$</span><span class="va">day30</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">gusto</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="co"># outcome rate</span></span>
<span><span class="co">#&gt; [1] 0.06982611</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">234</span><span class="op">)</span></span>
<span><span class="va">gusto</span> <span class="op">&lt;-</span> <span class="va">gusto</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">gusto</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">4000</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">gusto</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod_iv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate.html">validate</a></span><span class="op">(</span><span class="va">mod</span>, B <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="co">#&gt; It is recommended that B &gt;= 200 for bootstrap validation</span></span>
<span><span class="va">mod_iv</span></span>
<span><span class="co">#&gt;           apparent optimism corrected  n</span></span>
<span><span class="co">#&gt; C           0.7983  0.00385   0.79446 20</span></span>
<span><span class="co">#&gt; Brier       0.0603 -0.00063   0.06094 20</span></span>
<span><span class="co">#&gt; Intercept   0.0000  0.00687  -0.00687 20</span></span>
<span><span class="co">#&gt; Slope       1.0000  0.00837   0.99163 20</span></span>
<span><span class="co">#&gt; Eavg        0.0023  0.00123   0.00108 20</span></span>
<span><span class="co">#&gt; E50         0.0014  0.00107   0.00034 20</span></span>
<span><span class="co">#&gt; E90         0.0044  0.00280   0.00160 20</span></span>
<span><span class="co">#&gt; Emax        0.0447  0.04581  -0.00112 20</span></span>
<span><span class="co">#&gt; ECI         0.0017  0.00704  -0.00530 20</span></span></code></pre></div>
<p>As this <code>validate</code> call was run with
<code>method = "boot_optimism"</code> we are able to assess model
stability via the following calls. Note that these stability plots are
not based on the estimates of optimism but rather based on predictions
from models developed on bootstrapped resampled data sets evaluated on
the original/development data. In that sense it is conceptually more
related to the bias-corrected estimates obtained from
<code>method = "boot_simple"</code>. In any case both methods results in
the necessary data to make these plots (see also
<code>classification_stability</code> and
<code>dcurve_stability</code>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># prediction stability plot with 95% 'stability interval'</span></span>
<span><span class="fu"><a href="../reference/prediction_stability.html">prediction_stability</a></span><span class="op">(</span><span class="va">mod_iv</span>, bounds <span class="op">=</span> <span class="fl">.95</span><span class="op">)</span></span></code></pre></div>
<p><img src="pminternal_files/figure-html/unnamed-chunk-2-1.png" width="576"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># calibration stability </span></span>
<span><span class="co"># (using default calibration curve arguments: see pminternal:::cal_defaults())</span></span>
<span><span class="fu"><a href="../reference/calibration_stability.html">calibration_stability</a></span><span class="op">(</span><span class="va">mod_iv</span><span class="op">)</span></span></code></pre></div>
<p><img src="pminternal_files/figure-html/unnamed-chunk-2-2.png" width="576"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># mean absolute prediction error (mape) stability </span></span>
<span><span class="co"># mape = average difference between boot model predictions</span></span>
<span><span class="co"># for original data and original model</span></span>
<span><span class="va">mape</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mape_stability.html">mape_stability</a></span><span class="op">(</span><span class="va">mod_iv</span><span class="op">)</span></span></code></pre></div>
<p><img src="pminternal_files/figure-html/unnamed-chunk-2-3.png" width="576"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mape</span><span class="op">$</span><span class="va">average_mape</span></span>
<span><span class="co">#&gt; [1] 0.009233709</span></span></code></pre></div>
<p>It is possible to get apparent and bias-corrected calibration curves.
For this we need to set an additional argument, specifying where to
assess the calibration curve (i.e., points on the x-axis) as follows. We
can also select how calibration curves will be estimated. In this case
we use a restricted cubic spline with 5 knots (see
<code><a href="../reference/cal_defaults.html">pminternal::cal_defaults()</a></code> for the default settings).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># find 100 equally spaced points </span></span>
<span><span class="co"># between the lowest and highest risk prediction</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, type<span class="op">=</span><span class="st">"response"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span>, length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod_iv2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate.html">validate</a></span><span class="op">(</span><span class="va">mod</span>, B <span class="op">=</span> <span class="fl">20</span>, </span>
<span>                    calib_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                      eval<span class="op">=</span><span class="va">p_range</span>, </span>
<span>                      smooth<span class="op">=</span><span class="st">"rcs"</span>, </span>
<span>                      nk<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span>                    <span class="op">)</span></span>
<span><span class="co">#&gt; It is recommended that B &gt;= 200 for bootstrap validation</span></span>
<span><span class="va">mod_iv2</span></span>
<span><span class="co">#&gt;           apparent optimism corrected  n</span></span>
<span><span class="co">#&gt; C           0.7983  0.00204    0.7963 20</span></span>
<span><span class="co">#&gt; Brier       0.0603 -0.00096    0.0613 20</span></span>
<span><span class="co">#&gt; Intercept   0.0000  0.02506   -0.0251 20</span></span>
<span><span class="co">#&gt; Slope       1.0000  0.01743    0.9826 20</span></span>
<span><span class="co">#&gt; Eavg        0.0068 -0.00061    0.0074 20</span></span>
<span><span class="co">#&gt; E50         0.0063  0.00021    0.0060 20</span></span>
<span><span class="co">#&gt; E90         0.0106 -0.00030    0.0109 20</span></span>
<span><span class="co">#&gt; Emax        0.0820 -0.00523    0.0873 20</span></span>
<span><span class="co">#&gt; ECI         0.0092 -0.00136    0.0105 20</span></span>
<span></span>
<span><span class="va">calp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cal_plot.html">cal_plot</a></span><span class="op">(</span><span class="va">mod_iv2</span><span class="op">)</span></span></code></pre></div>
<p><img src="pminternal_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
<p>The plotting functions are fairly basic but all invisibly return the
data needed to reproduce them as you like. For example, the plot below
uses <code>ggplot2</code> and adds a histogram of the predicted risk
probabilities (stored in <code>p</code>) to show their distribution.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">calp</span><span class="op">)</span></span>
<span><span class="co">#&gt;     predicted    apparent bias_corrected</span></span>
<span><span class="co">#&gt; 1 0.001661484 0.006418392    0.007972031</span></span>
<span><span class="co">#&gt; 2 0.009484478 0.007824631    0.008528307</span></span>
<span><span class="co">#&gt; 3 0.017307471 0.010911750    0.010198648</span></span>
<span><span class="co">#&gt; 4 0.025130465 0.017945390    0.017133285</span></span>
<span><span class="co">#&gt; 5 0.032953458 0.028541737    0.028377736</span></span>
<span><span class="co">#&gt; 6 0.040776452 0.040675895    0.041411019</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">calp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">predicted</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">apparent</span>, color<span class="op">=</span><span class="st">"Apparent"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">bias_corrected</span>, color<span class="op">=</span><span class="st">"Bias-Corrected"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>p <span class="op">=</span> <span class="va">p</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">p</span>, y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html" class="external-link">after_stat</a></span><span class="op">(</span><span class="va">density</span><span class="op">)</span><span class="op">*</span><span class="fl">.01</span><span class="op">)</span>,</span>
<span>                 binwidth <span class="op">=</span> <span class="fl">.001</span>, inherit.aes <span class="op">=</span> <span class="cn">F</span>, alpha<span class="op">=</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Predicted Risk"</span>, y<span class="op">=</span><span class="st">"Estimated Risk"</span>, color<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="pminternal_files/figure-html/unnamed-chunk-4-1.png" width="576"></p>
<p>Finally, bootstrap confidence intervals can be calculated (see <a href="https://onlinelibrary.wiley.com/doi/10.1002/sim.9148" class="external-link uri">https://onlinelibrary.wiley.com/doi/10.1002/sim.9148</a> and
<code><a href="../reference/confint.internal_validatesummary.html">pminternal::confint.internal_validate</a></code> for details).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">mod_iv2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">mod_iv2</span>, method <span class="op">=</span> <span class="st">"shifted"</span>, R<span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           apparent optimism corrected  n corrected_lower corrected_upper</span></span>
<span><span class="co">#&gt; C           0.7983  0.00204    0.7963 20          0.7724           0.826</span></span>
<span><span class="co">#&gt; Brier       0.0603 -0.00096    0.0613 20          0.0548           0.066</span></span>
<span><span class="co">#&gt; Intercept   0.0000  0.02506   -0.0251 20         -0.0251          -0.025</span></span>
<span><span class="co">#&gt; Slope       1.0000  0.01743    0.9826 20          0.9826           0.983</span></span>
<span><span class="co">#&gt; Eavg        0.0068 -0.00061    0.0074 20          0.0039           0.013</span></span>
<span><span class="co">#&gt; E50         0.0063  0.00021    0.0060 20          0.0026           0.011</span></span>
<span><span class="co">#&gt; E90         0.0106 -0.00030    0.0109 20          0.0060           0.026</span></span>
<span><span class="co">#&gt; Emax        0.0820 -0.00523    0.0873 20          0.0161           0.198</span></span>
<span><span class="co">#&gt; ECI         0.0092 -0.00136    0.0105 20          0.0030           0.042</span></span></code></pre></div>
<p>And if confidence intervals are available they are plotted by
<code>cal_plot</code> by default.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cal_plot.html">cal_plot</a></span><span class="op">(</span><span class="va">mod_iv2</span>, bc_col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="pminternal_files/figure-html/unnamed-chunk-6-1.png" width="576"></p>
<p>Additional models that could be supplied via <code>fit</code> and
that I have tested on this gusto example are given below. Please let me
know if you run into trouble with a model class that you feel should
work with <code>fit</code>. The chunk below is not evaluated for build
time so does not print any output.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### generalized boosted model with gbm</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/gbm-developers/gbm" class="external-link">gbm</a></span><span class="op">)</span></span>
<span><span class="co"># syntax y ~ . does not work with gbm</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gbm/man/gbm.html" class="external-link">gbm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">hyp</span> <span class="op">+</span> <span class="va">htn</span> <span class="op">+</span> <span class="va">hrt</span> <span class="op">+</span> <span class="va">pmi</span> <span class="op">+</span> <span class="va">ste</span>, </span>
<span>           data <span class="op">=</span> <span class="va">gusto</span>, distribution <span class="op">=</span> <span class="st">"bernoulli"</span>, interaction.depth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">gbm_iv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate.html">validate</a></span><span class="op">(</span><span class="va">mod</span>, B <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### generalized additive model with mgcv</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span> <span class="op">+</span> <span class="va">hyp</span> <span class="op">+</span> <span class="va">htn</span> <span class="op">+</span> <span class="va">hrt</span> <span class="op">+</span> <span class="va">pmi</span> <span class="op">+</span> <span class="va">ste</span>, </span>
<span>           data <span class="op">=</span> <span class="va">gusto</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">gam_iv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate.html">validate</a></span><span class="op">(</span><span class="va">mod</span>, B <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### rms implementation of logistic regression</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">rms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rms/man/lrm.html" class="external-link">lrm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">gusto</span><span class="op">)</span> </span>
<span><span class="co"># not loading rms to avoid conflict with rms::validate...</span></span>
<span></span>
<span><span class="op">(</span><span class="va">lrm_iv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate.html">validate</a></span><span class="op">(</span><span class="va">mod</span>, B <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="user-defined-model-development-functions">User-defined model development functions<a class="anchor" aria-label="anchor" href="#user-defined-model-development-functions"></a>
</h2>
<p>It is important that what is being internally validated is the
<em>entire model development procedure</em>, including any tuning of
hyperparameters, variable selection, and so on. Often a <code>fit</code>
object will not capture this (or will not be supported).</p>
<p>In the example below we work with a model that is not supported by
<code>insight</code> or <code>marginaleffects</code>: logistic
regression with lasso (L1) regularization. The functions we need to
specify are <code>model_fun</code> and <code>pred_fun</code>.</p>
<ul>
<li>
<code>model_fun</code> should take a single argument,
<code>data</code>, and return and object that can be used to make
predictions with <code>pred_fun</code>. <code>...</code> should also be
added as an argument to allow for optional arguments passed to
<code>validate</code> (see <code>vignette("pminternal-examples")</code>
for more examples of user-defined functions that take optional
arguments). <code>lasso_fun</code> formats data for <code>glmnet</code>,
then selects the hyperparameter, <code>lambda</code> (controls the
degree of regularization), via 10-fold cross-validation, and fits the
final model with the ‘best’ value of <code>lambda</code> and
returns.</li>
<li>
<code>pred_fun</code> should take two arguments, <code>model</code>
and <code>data</code>, as well as the optional argument(s)
<code>...</code>. <code>pred_fun</code> should work with the model
object returned by <code>model_fun</code>. <code>glmnet</code> objects
have their own <code>predict</code> method so the function
<code>lasso_predict</code> simply formats the data and returns the
predictions. <code>predict.glmnet</code> returns a matrix so we select
the first column to return a vector of predicted risks.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#library(glmnet)</span></span>
<span></span>
<span><span class="va">lasso_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">y</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'sex'</span>, <span class="st">'age'</span>, <span class="st">'hyp'</span>, <span class="st">'htn'</span>, <span class="st">'hrt'</span>, <span class="st">'pmi'</span>, <span class="st">'ste'</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">x</span><span class="op">$</span><span class="va">sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">sex</span> <span class="op">==</span> <span class="st">"male"</span><span class="op">)</span></span>
<span>  <span class="va">x</span><span class="op">$</span><span class="va">pmi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">pmi</span> <span class="op">==</span> <span class="st">"yes"</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">cv</span> <span class="op">&lt;-</span> <span class="fu">glmnet</span><span class="fu">::</span><span class="fu"><a href="https://glmnet.stanford.edu/reference/cv.glmnet.html" class="external-link">cv.glmnet</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span>, alpha<span class="op">=</span><span class="fl">1</span>, nfolds <span class="op">=</span> <span class="fl">10</span>, family<span class="op">=</span><span class="st">"binomial"</span><span class="op">)</span></span>
<span>  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">cv</span><span class="op">$</span><span class="va">lambda.min</span></span>
<span>  </span>
<span>  <span class="fu">glmnet</span><span class="fu">::</span><span class="fu"><a href="https://glmnet.stanford.edu/reference/glmnet.html" class="external-link">glmnet</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span>, alpha <span class="op">=</span> <span class="fl">1</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, family<span class="op">=</span><span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">lasso_predict</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">data</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'sex'</span>, <span class="st">'age'</span>, <span class="st">'hyp'</span>, <span class="st">'htn'</span>, <span class="st">'hrt'</span>, <span class="st">'pmi'</span>, <span class="st">'ste'</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">x</span><span class="op">$</span><span class="va">sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">sex</span> <span class="op">==</span> <span class="st">"male"</span><span class="op">)</span></span>
<span>  <span class="va">x</span><span class="op">$</span><span class="va">pmi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">pmi</span> <span class="op">==</span> <span class="st">"yes"</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="fu">glmnet</span><span class="fu">::</span><span class="fu"><a href="https://glmnet.stanford.edu/reference/predict.glmnet.html" class="external-link">predict.glmnet</a></span><span class="op">(</span><span class="va">model</span>, newx <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We recommend that you use <code>::</code> to refer to functions from
particular packages if you want to run bootstrapping in parallel. For
cores = 1 (or no cores argument supplied) or cross-validation this will
not be an issue.</p>
<p>The code below tests these functions out on <code>gusto</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lasso_app</span> <span class="op">&lt;-</span> <span class="fu">lasso_fun</span><span class="op">(</span><span class="va">gusto</span><span class="op">)</span></span>
<span><span class="va">lasso_p</span> <span class="op">&lt;-</span> <span class="fu">lasso_predict</span><span class="op">(</span>model <span class="op">=</span> <span class="va">lasso_app</span>, data <span class="op">=</span> <span class="va">gusto</span><span class="op">)</span></span></code></pre></div>
<p>They work as intended so we can pass these functions to
<code>validate</code> as follows. Here we are using cross-validation to
estimate optimism. Note that the 10-fold cross-validation to select the
best value of <code>lambda</code> (i.e., hyperparameter tuning) is done
on each fold performed by <code>validate</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for calibration plot</span></span>
<span><span class="va">eval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">lasso_p</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lasso_p</span><span class="op">)</span>, length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">iv_lasso</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate.html">validate</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"cv_optimism"</span>, data <span class="op">=</span> <span class="va">gusto</span>, </span>
<span>                     outcome <span class="op">=</span> <span class="st">"y"</span>, model_fun <span class="op">=</span> <span class="va">lasso_fun</span>, </span>
<span>                     pred_fun <span class="op">=</span> <span class="va">lasso_predict</span>, B <span class="op">=</span> <span class="fl">10</span>, </span>
<span>                     calib_args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>eval<span class="op">=</span><span class="va">eval</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">iv_lasso</span></span>
<span><span class="co">#&gt;           apparent optimism corrected  n</span></span>
<span><span class="co">#&gt; C           0.7982  0.00053    0.7977 10</span></span>
<span><span class="co">#&gt; Brier       0.0603  0.00000    0.0603 10</span></span>
<span><span class="co">#&gt; Intercept   0.0362  0.00898    0.0272 10</span></span>
<span><span class="co">#&gt; Slope       1.0173 -0.00657    1.0239 10</span></span>
<span><span class="co">#&gt; Eavg        0.0023 -0.00977    0.0121 10</span></span>
<span><span class="co">#&gt; E50         0.0019 -0.00567    0.0075 10</span></span>
<span><span class="co">#&gt; E90         0.0047 -0.02296    0.0276 10</span></span>
<span><span class="co">#&gt; Emax        0.0335 -0.05879    0.0923 10</span></span>
<span><span class="co">#&gt; ECI         0.0011 -0.04708    0.0482 10</span></span>
<span></span>
<span><span class="fu"><a href="../reference/cal_plot.html">cal_plot</a></span><span class="op">(</span><span class="va">iv_lasso</span><span class="op">)</span></span></code></pre></div>
<p><img src="pminternal_files/figure-html/unnamed-chunk-10-1.png" width="576"></p>
<p>For more examples of user defined model functions (including elastic
net and random forest) can be found in
<code><a href="../articles/validate-examples.html">vignette("validate-examples")</a></code>.</p>
</div>
<div class="section level2">
<h2 id="user-defined-score-functions">User-defined score functions<a class="anchor" aria-label="anchor" href="#user-defined-score-functions"></a>
</h2>
<p>The scores returned by <code>score_binary</code> should be enough for
most clinical prediction model applications but sometimes different
measures may be desired. This can be achieved by specifying
<code>score_fun</code>. This should take two arguments, <code>y</code>
and <code>p</code>, and can take optional arguments.
<code>score_fun</code> should return a named vector of scores calculated
from <code>y</code> and <code>p</code>.</p>
<p>The function <code>sens_spec</code> takes an optional argument
<code>threshold</code> that is used to calculate sensitivity and
specificity. If <code>threshold</code> is not specified it is set to
0.5.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sens_spec</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">p</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># this function supports an optional</span></span>
<span>  <span class="co"># arg: threshold (set to .5 if not specified)</span></span>
<span>  <span class="va">dots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="st">"threshold"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dots</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">thresh</span> <span class="op">&lt;-</span> <span class="va">dots</span><span class="op">[[</span><span class="st">"threshold"</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="va">thresh</span> <span class="op">&lt;-</span> <span class="fl">.5</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># make sure y is 1/0</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">is.logical</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="co"># predicted 'class'</span></span>
<span>  <span class="va">pcla</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">p</span> <span class="op">&gt;</span> <span class="va">thresh</span><span class="op">)</span> </span>
<span></span>
<span>  <span class="va">sens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">==</span><span class="fl">1</span> <span class="op">&amp;</span> <span class="va">pcla</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">==</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">pcla</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sens</span>, <span class="va">spec</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sensitivity"</span>, <span class="st">"Specificity"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The call to <code>validate</code> below uses the <code>glm</code> fit
from the beginning of this vignette and uses the <code>sens_spec</code>
function to calculate bias-corrected sensitivity and specificity with a
threshold of 0.2 (in this case assessing classification stability would
be important).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/validate.html">validate</a></span><span class="op">(</span>fit <span class="op">=</span> <span class="va">mod</span>, score_fun <span class="op">=</span> <span class="va">sens_spec</span>, threshold<span class="op">=</span><span class="fl">.2</span>,</span>
<span>         method <span class="op">=</span> <span class="st">"cv_optimism"</span>, B <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;             apparent optimism corrected  n</span></span>
<span><span class="co">#&gt; Sensitivity     0.31 0.003943      0.31 10</span></span>
<span><span class="co">#&gt; Specificity     0.94 0.000015      0.94 10</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Stephen Rhodes.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
