<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Internal Validation of Clinical Prediction Models • pminternal</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Internal Validation of Clinical Prediction Models">
<meta name="description" content="Conduct internal validation of a clinical prediction model for a binary outcome. Produce bias corrected performance metrics (c-statistic, calibration slope) via bootstrap (simple bootstrap, bootstrap optimism, .632 optimism) and crossvalidation (CV optimism, CV average). Also includes functions to assess model stability via bootstrap resampling. See Steyerberg et al. (2001) &lt;doi:10.1016/s0895-4356(01)00341-9&gt;; Harrell (2015) &lt;doi:10.1007/978-3-319-19425-7&gt;; Riley and Collins (2023) &lt;doi:10.1002/bimj.202200302&gt;">
<meta property="og:description" content="Conduct internal validation of a clinical prediction model for a binary outcome. Produce bias corrected performance metrics (c-statistic, calibration slope) via bootstrap (simple bootstrap, bootstrap optimism, .632 optimism) and crossvalidation (CV optimism, CV average). Also includes functions to assess model stability via bootstrap resampling. See Steyerberg et al. (2001) &lt;doi:10.1016/s0895-4356(01)00341-9&gt;; Harrell (2015) &lt;doi:10.1007/978-3-319-19425-7&gt;; Riley and Collins (2023) &lt;doi:10.1002/bimj.202200302&gt;">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">pminternal</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="articles/pminternal.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="articles/missing-data.html">Handling missing data</a></li>
    <li><a class="dropdown-item" href="articles/validate-examples.html">More examples</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stephenrho/pminternal/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="pminternal-internal-validation-of-clinical-prediction-models">pminternal: Internal Validation of Clinical Prediction Models<a class="anchor" aria-label="anchor" href="#pminternal-internal-validation-of-clinical-prediction-models"></a>
</h1></div>
<!-- badges: start -->
<!-- badges: end -->
<p>The goal is to offer a package that can produce bias-corrected performance measures for clinical prediction models with binary outcomes for a range of model development approaches available in R (similar to <code><a href="https://rdrr.io/pkg/rms/man/validate.html" class="external-link">rms::validate</a></code>). There are also functions for assessing prediction stability, as described in <a href="https://doi.org/10.1002/bimj.202200302" class="external-link">Riley and Collins (2023)</a>.</p>
<p>To install:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"pminternal"</span><span class="op">)</span> <span class="co"># cran</span></span>
<span><span class="co"># or </span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"stephenrho/pminternal"</span><span class="op">)</span> <span class="co"># development</span></span></code></pre></div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>In the example below we use bootstrapping to correct performance measures for a <code>glm</code> via calculation of ‘optimism’ (see <code><a href="articles/pminternal.html">vignette("pminternal")</a></code> and <code><a href="articles/validate-examples.html">vignette("validate-examples")</a></code> for more examples):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stephenrho/pminternal" class="external-link">pminternal</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make some data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2345</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">800</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="va">p</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="va">p</span><span class="op">)</span></span>
<span><span class="va">LP</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="co"># first 5 variables predict outcome</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">LP</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fit a model</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate bootstrap optimism corrected performance measures</span></span>
<span><span class="op">(</span><span class="va">val</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/validate.html">validate</a></span><span class="op">(</span>fit <span class="op">=</span> <span class="va">mod</span>, method <span class="op">=</span> <span class="st">"boot_optimism"</span>, B <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; It is recommended that B &gt;= 200 for bootstrap validation</span></span>
<span><span class="co">#&gt;           apparent optimism corrected   n</span></span>
<span><span class="co">#&gt; C           0.8567   0.0093    0.8474 100</span></span>
<span><span class="co">#&gt; Brier       0.1423  -0.0054    0.1477 100</span></span>
<span><span class="co">#&gt; Intercept   0.0000   0.0175   -0.0175 100</span></span>
<span><span class="co">#&gt; Slope       1.0000   0.0529    0.9471 100</span></span>
<span><span class="co">#&gt; Eavg        0.0045  -0.0048    0.0093 100</span></span>
<span><span class="co">#&gt; E50         0.0039  -0.0050    0.0089 100</span></span>
<span><span class="co">#&gt; E90         0.0081  -0.0107    0.0187 100</span></span>
<span><span class="co">#&gt; Emax        0.0109  -0.0057    0.0165 100</span></span>
<span><span class="co">#&gt; ECI         0.0027  -0.0038    0.0065 100</span></span></code></pre></div>
<p>The other available methods for calculating bias corrected performance are the simple bootstrap (<code>boot_simple</code>), 0.632 bootstrap optimism (<code>.632</code>), optimism via cross-validation (<code>cv_optimism</code>), and regular cross-validation (<code>cv_average</code>). Please see <code><a href="reference/validate.html">?pminternal::validate</a></code> and the references therein. Bias corrected calibration curves can also be produced (see <code>cal_plot</code>). Confidence intervals can also be added via <code>confint</code>.</p>
<p>For models that cannot be supported via <code>fit</code>, users are able to specify their own model (<code>model_fun</code>) and prediction (<code>pred_fun</code>) functions as shown below. Note that when specifying user-defined model and prediction functions the data and outcome must also be provided. It is crucial that <code>model_fun</code> implements the entire model development procedure (variable selection, hyperparameter tuning, etc). For more examples, see <code><a href="articles/pminternal.html">vignette("pminternal")</a></code> and <code><a href="articles/validate-examples.html">vignette("validate-examples")</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fit a glm with lasso penalty</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glmnet.stanford.edu" class="external-link">glmnet</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: Matrix</span></span>
<span><span class="co">#&gt; Loaded glmnet 4.1-8</span></span>
<span></span>
<span><span class="va">lasso_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">y</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glmnet.stanford.edu/reference/cv.glmnet.html" class="external-link">cv.glmnet</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span>, alpha<span class="op">=</span><span class="fl">1</span>, nfolds <span class="op">=</span> <span class="fl">10</span>, family<span class="op">=</span><span class="st">"binomial"</span><span class="op">)</span></span>
<span>  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">cv</span><span class="op">$</span><span class="va">lambda.min</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://glmnet.stanford.edu/reference/glmnet.html" class="external-link">glmnet</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span>, alpha <span class="op">=</span> <span class="fl">1</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, family<span class="op">=</span><span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">lasso_predict</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">data</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">y</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, newx <span class="op">=</span> <span class="va">x</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="op">(</span><span class="va">val</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/validate.html">validate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, outcome <span class="op">=</span> <span class="st">"y"</span>, </span>
<span>                 model_fun <span class="op">=</span> <span class="va">lasso_fun</span>, pred_fun <span class="op">=</span> <span class="va">lasso_predict</span>, </span>
<span>                 method <span class="op">=</span> <span class="st">"boot_optimism"</span>, B <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; It is recommended that B &gt;= 200 for bootstrap validation</span></span>
<span><span class="co">#&gt;           apparent optimism corrected   n</span></span>
<span><span class="co">#&gt; C            0.856   0.0070     0.849 100</span></span>
<span><span class="co">#&gt; Brier        0.143  -0.0041     0.147 100</span></span>
<span><span class="co">#&gt; Intercept    0.080   0.0191     0.061 100</span></span>
<span><span class="co">#&gt; Slope        1.155   0.0449     1.110 100</span></span>
<span><span class="co">#&gt; Eavg         0.020   0.0013     0.019 100</span></span>
<span><span class="co">#&gt; E50          0.019   0.0026     0.017 100</span></span>
<span><span class="co">#&gt; E90          0.040   0.0021     0.038 100</span></span>
<span><span class="co">#&gt; Emax         0.044   0.0145     0.029 100</span></span>
<span><span class="co">#&gt; ECI          0.053   0.0087     0.044 100</span></span></code></pre></div>
<p>The output of <code>validate</code> (with <code>method = "boot_*"</code>) can be used to produce plots for assessing the stability of model predictions (across models developed on bootstrap resamples).</p>
<p>A prediction (in)stability plot shows predictions from the <code>B</code> (in this case 100) bootstrap models applied to the development data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/prediction_stability.html">prediction_stability</a></span><span class="op">(</span><span class="va">val</span>, smooth_bounds <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-stability-1.png" width="90%"></p>
<p>A MAPE plot shows the mean absolute prediction error, which is the difference between the predicted risk from the development model and each of the <code>B</code> bootstrap models.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/mape_stability.html">mape_stability</a></span><span class="op">(</span><span class="va">val</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-mape-1.png" width="90%"></p>
<p>A calibration (in)stability plot depict the original calibration curve along with <code>B</code> calibration curves from the bootstrap models applied to the original data (<code>y</code>).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/calibration_stability.html">calibration_stability</a></span><span class="op">(</span><span class="va">val</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-cal-1.png" width="90%"></p>
<p>The classification instability index (CII) is the proportion of individuals that change predicted class (present/absent, 1/0) when predicted risk is compared to some threshold. For example, a patient predicted to be in class 1 would receive a CII of 0.3 if 30% of the bootstrap models led to a predicted class of 0.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/classification_stability.html">classification_stability</a></span><span class="op">(</span><span class="va">val</span>, threshold <span class="op">=</span> <span class="fl">.4</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-CII-1.png" width="90%"></p>
<p>Decision curves implied by the original and bootstrap models can also be plotted.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/dcurve_stability.html">dcurve_stability</a></span><span class="op">(</span><span class="va">val</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-dcurve-1.png" width="90%"></p>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/stephenrho/pminternal/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/stephenrho/pminternal/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/GPL-3" class="external-link">GPL-3</a></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing pminternal</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Stephen Rhodes <br><small class="roles"> Author, maintainer, copyright holder </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Stephen Rhodes.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
