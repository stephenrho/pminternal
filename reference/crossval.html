<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Estimate bias-corrected scores via cross-validation. CV is used to calculate optimism
which is then subtracted from apparent scores and to calculate average performance in the
out of sample (held out) data.
This function is called by validate."><title>Calculate bias-corrected scores via cross-validation — crossval • pminternal</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calculate bias-corrected scores via cross-validation — crossval"><meta property="og:description" content="Estimate bias-corrected scores via cross-validation. CV is used to calculate optimism
which is then subtracted from apparent scores and to calculate average performance in the
out of sample (held out) data.
This function is called by validate."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">pminternal</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="../articles/pminternal.html">Get started</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/validate-examples.html">More `model_fun` examples for `pminternal::validate`</a>
  </div>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/stephenrho/pminternal/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Calculate bias-corrected scores via cross-validation</h1>
      <small class="dont-index">Source: <a href="https://github.com/stephenrho/pminternal/blob/HEAD/R/crossval.R" class="external-link"><code>R/crossval.R</code></a></small>
      <div class="d-none name"><code>crossval.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Estimate bias-corrected scores via cross-validation. CV is used to calculate optimism
which is then subtracted from apparent scores and to calculate average performance in the
out of sample (held out) data.
This function is called by <code><a href="validate.html">validate</a></code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">crossval</span><span class="op">(</span><span class="va">data</span>, <span class="va">outcome</span>, <span class="va">model_fun</span>, <span class="va">pred_fun</span>, <span class="va">score_fun</span>, k <span class="op">=</span> <span class="fl">10</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>data</dt>
<dd><p>the data used in developing the model. Should contain all variables considered (i.e., even those excluded by variable selection in the development sample)</p></dd>


<dt>outcome</dt>
<dd><p>character denoting the column name of the outcome in <code>data</code>.</p></dd>


<dt>model_fun</dt>
<dd><p>a function that takes at least one argument, <code>data</code>. This function should implement the entire model development procedure (i.e., hyperparameter tuning, variable selection, imputation). Additional arguments can be provided via <code>...</code>. This function should return an object that works with <code>pred_fun</code>.</p></dd>


<dt>pred_fun</dt>
<dd><p>function that takes at least two arguments, <code>model</code> and <code>data</code>. This function should return a numeric vector of predicted probabilities of the outcome with the same length as the number of rows in <code>data</code> so it is important to take into account how missing data is treated (e.g., <code>predict.glm</code> omits predictions for rows with missing values).</p></dd>


<dt>score_fun</dt>
<dd><p>a function to calculate the metrics of interest. If this is not specified <code><a href="score_binary.html">score_binary</a></code> is used.</p></dd>


<dt>k</dt>
<dd><p>number of folds. Typically scores need &gt;&gt; 2 observations to be calculated so folds should be chosen with this in mind.</p></dd>


<dt>...</dt>
<dd><p>additional arguments for <code>model_fun</code>, <code>pred_fun</code>, and/or <code>score_fun</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>a list of class <code>internal_cv</code> containing:</p><ul><li><p><code>apparent</code> - scores calculated on the original data using the original model.</p></li>
<li><p><code>optimism</code> - estimates of optimism for each score (average difference in score for training data vs test data on each fold) which can be subtracted from 'apparent' performance calculated using the original model on the original data.</p></li>
<li><p><code>cv_optimism_corrected</code> - 'bias corrected' scores (apparent - optimism). This is what is produced by <code><a href="https://rdrr.io/pkg/rms/man/validate.html" class="external-link">rms::validate</a></code>, <code><a href="https://rdrr.io/pkg/rms/man/predab.resample.html" class="external-link">rms::predab.resample</a></code>.</p></li>
<li><p><code>cv_average</code> - average of scores calculated on the test (held out) data. This is the metric described in Steyerberg et al. (2001).</p></li>
<li><p><code>indices</code> - indices used to define test set on each fold.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Steyerberg, E. W., Harrell Jr, F. E., Borsboom, G. J., Eijkemans, M. J. C., Vergouwe, Y., &amp; Habbema, J. D. F. (2001). Internal validation of predictive models: efficiency of some procedures for logistic regression analysis. Journal of clinical epidemiology, 54(8), 774-781.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stephenrho/pminternal" class="external-link">pminternal</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># simulate data with two predictors that interact</span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">pmcalibration</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pmcalibration/man/sim_dat.html" class="external-link">sim_dat</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">1000</span>, a1 <span class="op">=</span> <span class="op">-</span><span class="fl">2</span>, a3 <span class="op">=</span> <span class="op">-</span><span class="fl">.3</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.186</span>
<span class="r-in"><span><span class="va">dat</span><span class="op">$</span><span class="va">LP</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="co"># remove linear predictor</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># fit a (misspecified) logistic regression model</span></span></span>
<span class="r-in"><span><span class="co">#m1 &lt;- glm(y ~ x1 + x2, data=dat, family="binomial")</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">model_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span>, data<span class="op">=</span><span class="va">data</span>, family<span class="op">=</span><span class="st">"binomial"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">pred_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">data</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, newdata<span class="op">=</span><span class="va">data</span>, type<span class="op">=</span><span class="st">"response"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># CV Corrected = Apparent - CV Optimism</span></span></span>
<span class="r-in"><span><span class="co"># CV Average = average score in held out fold</span></span></span>
<span class="r-in"><span><span class="fu">crossval</span><span class="op">(</span>data<span class="op">=</span><span class="va">dat</span>, outcome<span class="op">=</span><span class="st">"y"</span>, model_fun<span class="op">=</span><span class="va">model_fun</span>, pred_fun<span class="op">=</span><span class="va">pred_fun</span>, k<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    C   Brier Intercept  Slope   Eavg    E50    E90  Emax    ECI</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Apparent      0.7964  0.1262   6.6e-15  1.000  0.020  0.016  0.033  0.10  0.062</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> CV Optimism  -0.0024 -0.0013   2.7e-02 -0.033 -0.037 -0.029 -0.077 -0.11 -0.561</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> CV Corrected  0.7988  0.1275  -2.7e-02  1.033  0.056  0.045  0.110  0.21  0.622</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> CV Average    0.7989  0.1274  -2.7e-02  1.033  0.056  0.045  0.110  0.21  0.624</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Stephen Rhodes.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

